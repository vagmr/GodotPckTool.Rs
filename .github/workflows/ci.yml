name: Release

on:
  push:
    tags:
      - "v*.*.*"

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests
        run: cargo test --workspace --verbose

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Run clippy
        run: cargo clippy --workspace --all-targets

  fmt:
    name: Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt

      - name: Check formatting
        run: cargo fmt --all -- --check

  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    needs: [test, clippy, fmt]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --verbose

      - name: Smoke test
        run: ./target/release/godotpcktool --help

      - name: Package artifact
        run: |
          cd target/release
          tar -czvf godotpcktool-linux-x86_64.tar.gz godotpcktool
          mv godotpcktool-linux-x86_64.tar.gz ../../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: godotpcktool-linux-x86_64
          path: godotpcktool-linux-x86_64.tar.gz

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: [test, clippy, fmt]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --verbose

      - name: Smoke test
        run: ./target/release/godotpcktool.exe --help

      - name: Package artifact
        run: |
          cd target/release
          Compress-Archive -Path godotpcktool.exe -DestinationPath godotpcktool-windows-x86_64.zip
          Move-Item godotpcktool-windows-x86_64.zip ../../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: godotpcktool-windows-x86_64
          path: godotpcktool-windows-x86_64.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    needs: [test, clippy, fmt]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: cargo build --release --verbose

      - name: Smoke test
        run: ./target/release/godotpcktool --help

      - name: Package artifact
        run: |
          cd target/release
          tar -czvf godotpcktool-macos-x86_64.tar.gz godotpcktool
          mv godotpcktool-macos-x86_64.tar.gz ../../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: godotpcktool-macos-x86_64
          path: godotpcktool-macos-x86_64.tar.gz

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, build-macos]
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION="${GITHUB_REF#refs/tags/}"
          # Extract content between this version and the next version header (or end of file)
          # Matches ## [vX.X.X] or ## vX.X.X format
          awk -v ver="$VERSION" '
            BEGIN { found=0; printing=0 }
            /^## \[?v?[0-9]+\.[0-9]+\.[0-9]+/ {
              if (printing) exit
              if (index($0, ver) || index($0, substr(ver, 2))) { found=1; printing=1 }
            }
            printing { print }
          ' CHANGELOG.md > RELEASE_NOTES.md

          # If no specific version found, use a default message
          if [ ! -s RELEASE_NOTES.md ]; then
            echo "## $VERSION" > RELEASE_NOTES.md
            echo "" >> RELEASE_NOTES.md
            echo "See [CHANGELOG.md](https://github.com/vagmr/GodotPckTool/blob/main/CHANGELOG.md) for details." >> RELEASE_NOTES.md
          fi

          # Append download section
          echo "" >> RELEASE_NOTES.md
          echo "### ðŸ“¥ Downloads" >> RELEASE_NOTES.md
          echo "- **Windows**: \`godotpcktool-windows-x86_64.zip\`" >> RELEASE_NOTES.md
          echo "- **Linux**: \`godotpcktool-linux-x86_64.tar.gz\`" >> RELEASE_NOTES.md
          echo "- **macOS**: \`godotpcktool-macos-x86_64.tar.gz\`" >> RELEASE_NOTES.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: GodotPckTool ${{ steps.version.outputs.VERSION }}
          body_path: RELEASE_NOTES.md
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') || contains(github.ref, 'rc') }}
          files: |
            artifacts/godotpcktool-linux-x86_64/godotpcktool-linux-x86_64.tar.gz
            artifacts/godotpcktool-windows-x86_64/godotpcktool-windows-x86_64.zip
            artifacts/godotpcktool-macos-x86_64/godotpcktool-macos-x86_64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
